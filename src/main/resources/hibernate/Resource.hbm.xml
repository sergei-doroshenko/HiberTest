<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="acl.domain.resource">
    <class name="acl.domain.resource.Resource" table="resources" entity-name="Resource"
           dynamic-insert="true" dynamic-update="true" >

        <id name="id" type="java.lang.Long" column="id">
            <generator class="native"/>
        </id>

        <property name="firstName" type="java.lang.String" column="first_name"/>
        <property name="lastName" type="java.lang.String" column="last_name"/>
        <property name="baseCost" type="java.lang.Double" column="base_cost"/>
        <property name="currencyId" type="java.lang.Long" column="currency_id"/>

        <!--<set name="skills" inverse="true" cascade="save-update" lazy="true" fetch="select">
            <key column="RES_ID" not-null="true" foreign-key="ID"/>
            <one-to-many entity-name="Skill"/>
        </set>-->

    </class>

    <sql-query name="resource.cost.changes.01">
        <![CDATA[
        SELECT
          a.resource_id,
          last_name || ' ' || first_name AS name,
          a.start_date,
          /* a.base_cost, */
          a.currency_id,
          a.exchange_rate,
          rc.letter_code AS currency_name
        FROM (
          SELECT
            rc.id,
            rc.resource_id,
            rc.start_date,
            rc.base_cost,
            rc.currency_id,
            ex.exchange_rate
          FROM resource_cost rc
          LEFT JOIN exchange_currency_rates ex ON ex.currency_from=rc.currency_id AND date=(
            SELECT max(date) FROM exchange_currency_rates WHERE currency_from=rc.currency_id AND date<=rc.start_date
          )

          UNION ALL
          SELECT
            rc.id,
            rc.resource_id,
            rc.start_date,
            rc.base_cost,
            rc.currency_id,
            ex.exchange_rate
          FROM exchange_currency_rates ex
          JOIN resource_cost rc ON rc.currency_id = ex.currency_from AND rc.start_date = (
            SELECT max(start_date) FROM resource_cost WHERE currency_id=ex.currency_from AND start_date<=ex.date
          ) AND NOT rc.id=COALESCE((SELECT id FROM resource_cost WHERE resource_id=rc.resource_id AND start_date=ex.date), 0)
        ) a
        LEFT JOIN resource r ON r.id=a.resource_id
        LEFT JOIN currency rc ON rc.id=a.currency_id
        WHERE
          a.start_date BETWEEN '2015-01-01' AND '2015-06-01'
        ORDER BY
          name,
          a.start_date;
        ]]>
    </sql-query>
</hibernate-mapping>